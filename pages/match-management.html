<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>赛事管理 - 武汉大学足球协会</title>
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/pages.css" />
  <link rel="stylesheet" href="../css/responsive.css" />
</head>
<body>
  <!-- 导航栏容器 -->
  <div id="navbar-container"></div>
  
  <!-- 加载导航栏脚本 -->
  <script src="../js/load-navbar.js"></script>

  <section class="p-5 pt-20">
    <div class="container">
      <h2 class="text-center mb-5">赛事管理</h2>
      
      <!-- 标签切换 -->
      <div class="mb-5">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link active" href="#schedule" onclick="showTab('schedule')" style="color: #00008B;">比赛日程</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#statistics" onclick="showTab('statistics')" style="color: #00008B;">赛事统计</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#teams" onclick="showTab('teams')" style="color: #00008B;">球队管理</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#referees" onclick="showTab('referees')" style="color: #00008B;">裁判管理</a>
          </li>
        </ul>
      </div>
      
      <!-- 比赛日程 -->
      <div id="schedule" class="tab-content">
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title">比赛日程表</h3>
            <div class="mb-4">
              <input type="date" id="scheduleDate" class="form-control" onchange="loadSchedule()">
            </div>
            <div id="scheduleList">
              <!-- 日程项将通过JavaScript动态添加 -->
              <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-2">加载日程中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 赛事统计 -->
      <div id="statistics" class="tab-content" style="display: none;">
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title">赛事统计</h3>
            <div id="matchStatistics" class="mb-4">
              <!-- 统计数据将通过JavaScript动态添加 -->
              <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-2">加载统计数据中...</p>
              </div>
            </div>
            
            <h4 class="card-subtitle mb-3">球队排行榜</h4>
            <div id="teamRanking">
              <!-- 排行榜将通过JavaScript动态添加 -->
              <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-2">加载排行榜中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 球队管理 -->
      <div id="teams" class="tab-content" style="display: none;">
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title">球队管理</h3>
            <div class="mb-4">
              <button class="btn btn-primary" onclick="showAddTeamForm()">添加球队</button>
            </div>
            <div id="teamsList">
              <!-- 球队列表将通过JavaScript动态添加 -->
              <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-2">加载球队中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 裁判管理 -->
      <div id="referees" class="tab-content" style="display: none;">
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title">裁判管理</h3>
            <div class="mb-4">
              <button class="btn btn-primary" onclick="showAddRefereeForm()">添加裁判</button>
            </div>
            <div id="refereesList">
              <!-- 裁判列表将通过JavaScript动态添加 -->
              <div class="col-12 text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">加载中...</span>
                </div>
                <p class="mt-2">加载裁判中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 添加球队模态框 -->
  <div class="modal" id="addTeamModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #00008B; color: white;">
          <h5 class="modal-title" style="color: white;">添加球队</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <form id="addTeamForm">
            <div class="mb-3">
              <label for="teamName" class="form-label">球队名称</label>
              <input type="text" class="form-control" id="teamName" required>
            </div>
            <div class="mb-3">
              <label for="teamCollege" class="form-label">所属学院</label>
              <input type="text" class="form-control" id="teamCollege" required>
            </div>
            <div class="mb-3">
              <label for="teamCoach" class="form-label">教练</label>
              <input type="text" class="form-control" id="teamCoach">
            </div>
            <div class="mb-3">
              <label for="teamLogo" class="form-label">队徽URL</label>
              <input type="text" class="form-control" id="teamLogo">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="addTeam()">添加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加裁判模态框 -->
  <div class="modal" id="addRefereeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #00008B; color: white;">
          <h5 class="modal-title" style="color: white;">添加裁判</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <form id="addRefereeForm">
            <div class="mb-3">
              <label for="refereeName" class="form-label">姓名</label>
              <input type="text" class="form-control" id="refereeName" required>
            </div>
            <div class="mb-3">
              <label for="refereeCollege" class="form-label">学院</label>
              <input type="text" class="form-control" id="refereeCollege">
            </div>
            <div class="mb-3">
              <label for="refereeGrade" class="form-label">年级</label>
              <input type="text" class="form-control" id="refereeGrade">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="addReferee()">添加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 编辑球队模态框 -->
  <div class="modal" id="editTeamModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #00008B; color: white;">
          <h5 class="modal-title" style="color: white;">编辑球队</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <form id="editTeamForm">
            <input type="hidden" id="editTeamId">
            <div class="mb-3">
              <label for="editTeamName" class="form-label">球队名称</label>
              <input type="text" class="form-control" id="editTeamName" required>
            </div>
            <div class="mb-3">
              <label for="editTeamCollege" class="form-label">所属学院</label>
              <input type="text" class="form-control" id="editTeamCollege" required>
            </div>
            <div class="mb-3">
              <label for="editTeamCoach" class="form-label">教练</label>
              <input type="text" class="form-control" id="editTeamCoach">
            </div>
            <div class="mb-3">
              <label for="editTeamLogo" class="form-label">队徽URL</label>
              <input type="text" class="form-control" id="editTeamLogo">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="editTeam()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 编辑裁判模态框 -->
  <div class="modal" id="editRefereeModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #00008B; color: white;">
          <h5 class="modal-title" style="color: white;">编辑裁判</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <form id="editRefereeForm">
            <input type="hidden" id="editRefereeId">
            <div class="mb-3">
              <label for="editRefereeName" class="form-label">姓名</label>
              <input type="text" class="form-control" id="editRefereeName" required>
            </div>
            <div class="mb-3">
              <label for="editRefereeCollege" class="form-label">学院</label>
              <input type="text" class="form-control" id="editRefereeCollege">
            </div>
            <div class="mb-3">
              <label for="editRefereeGrade" class="form-label">年级</label>
              <input type="text" class="form-control" id="editRefereeGrade">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="editReferee()">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 球员管理模态框 -->
  <div class="modal" id="playersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #00008B; color: white;">
          <h5 class="modal-title" id="playersModalTitle" style="color: white;">球员管理</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <button class="btn btn-primary" onclick="showAddPlayerForm()">添加球员</button>
          </div>
          <div id="playersList">
            <!-- 球员列表将通过JavaScript动态添加 -->
            <div class="col-12 text-center">
              <div class="spinner-border" role="status">
                <span class="sr-only">加载中...</span>
              </div>
              <p class="mt-2">加载球员中...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加球员模态框 -->
  <div class="modal" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #00008B; color: white;">
          <h5 class="modal-title" style="color: white;">添加球员</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
        </div>
        <div class="modal-body">
          <form id="addPlayerForm">
            <input type="hidden" id="addPlayerTeamId">
            <div class="mb-3">
              <label for="playerName" class="form-label">姓名</label>
              <input type="text" class="form-control" id="playerName" required>
            </div>
            <div class="mb-3">
              <label for="playerNumber" class="form-label">号码</label>
              <input type="number" class="form-control" id="playerNumber" min="1" max="99" required>
            </div>
            <div class="mb-3">
              <label for="playerStudentId" class="form-label">学号</label>
              <input type="text" class="form-control" id="playerStudentId" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="addPlayer()">添加</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="p-5 bg-dark text-white text-center">
    <div class="container">
      <p class="lead">Copyright &copy; 2026 武汉大学足球协会（学生）主页</p>
    </div>
  </footer>

  <script>
    // 移动端菜单控制
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const navLinks = document.getElementById('navLinks');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    mobileMenuBtn.addEventListener('click', function() {
      navLinks.classList.toggle('active');
      mobileMenuOverlay.classList.toggle('active');
      document.body.classList.toggle('menu-open');
    });
    
    mobileMenuOverlay.addEventListener('click', function() {
      navLinks.classList.remove('active');
      mobileMenuOverlay.classList.remove('active');
      document.body.classList.remove('menu-open');
    });
    
    // 下拉菜单控制
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    dropdownToggles.forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        e.preventDefault();
        const dropdownMenu = this.nextElementSibling;
        dropdownMenu.classList.toggle('active');
      });
    });
    
    // 点击其他地方关闭下拉菜单
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.nav-dropdown')) {
        const dropdownMenus = document.querySelectorAll('.dropdown-menu');
        dropdownMenus.forEach(menu => {
          menu.classList.remove('active');
        });
      }
    });
    
    // 检查用户登录状态
    function checkLoginStatus() {
      const userId = localStorage.getItem('userId');
      const userName = localStorage.getItem('userName');
      
      if (userId && userName) {
        // 用户已登录，显示用户信息和登出按钮
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('userNameDisplay').textContent = userName;
        document.getElementById('loginRegisterLink').style.display = 'none';
      } else {
        // 用户未登录，显示登录/注册链接
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('loginRegisterLink').style.display = 'block';
      }
    }
    
    // 登出功能
    function logout() {
      // 清除本地存储中的用户信息
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      
      // 更新导航栏显示
      checkLoginStatus();
      
      // 跳转到首页
      window.location.href = '../index.html';
    }
    
    // 切换标签
    function showTab(tabName) {
      // 隐藏所有标签内容
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // 移除所有活动标签
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // 显示选中的标签内容
      document.getElementById(tabName).style.display = 'block';
      
      // 添加活动标签样式
      event.target.classList.add('active');
      
      // 加载对应内容
      if (tabName === 'schedule') {
        loadSchedule();
      } else if (tabName === 'statistics') {
        loadStatistics();
      } else if (tabName === 'teams') {
        loadTeams();
      } else if (tabName === 'referees') {
        loadReferees();
      }
    }
    
    // 加载比赛日程
    async function loadSchedule() {
      try {
        const response = await fetch('http://localhost:3000/api/matches');
        const matches = await response.json();
        
        if (!response.ok) throw new Error(matches.error || '获取比赛数据失败');
        
        const scheduleDate = document.getElementById('scheduleDate').value;
        const filteredMatches = scheduleDate ? 
          matches.filter(match => match.date === scheduleDate) : 
          matches;
        
        displaySchedule(filteredMatches);
      } catch (err) {
        console.error('加载比赛日程失败:', err);
        document.getElementById('scheduleList').innerHTML = '<div class="col-12 text-center text-danger">加载比赛日程失败</div>';
      }
    }
    
    // 显示比赛日程
    function displaySchedule(matches) {
      const scheduleList = document.getElementById('scheduleList');
      if (matches.length === 0) {
        scheduleList.innerHTML = '<div class="col-12 text-center">暂无比赛</div>';
        return;
      }
      
      scheduleList.innerHTML = '';
      matches.forEach(match => {
        const matchItem = document.createElement('div');
        matchItem.className = 'mb-3 p-3 border rounded';
        matchItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5>${match.homeTeam} vs ${match.awayTeam}</h5>
              <p class="text-muted">${match.date} ${match.time} | ${match.venue}</p>
              <p class="text-muted">裁判: ${match.referee}</p>
            </div>
            <div class="text-center">
              <span class="badge ${match.status === 'completed' ? 'bg-success' : match.status === 'in-progress' ? 'bg-warning' : 'bg-info'}">
                ${match.status === 'completed' ? '已完成' : match.status === 'in-progress' ? '进行中' : '已安排'}
              </span>
              ${match.status === 'completed' ? `<p class="mt-2">${match.homeScore} - ${match.awayScore}</p>` : ''}
            </div>
          </div>
        `;
        scheduleList.appendChild(matchItem);
      });
    }
    
    // 加载赛事统计
    async function loadStatistics() {
      try {
        // 加载比赛统计
        const matchStatsResponse = await fetch('http://localhost:3000/api/statistics/matches');
        const matchStats = await matchStatsResponse.json();
        
        if (!matchStatsResponse.ok) throw new Error(matchStats.error || '获取比赛统计失败');
        
        // 加载球队统计
        const teamStatsResponse = await fetch('http://localhost:3000/api/statistics/teams');
        const teamStats = await teamStatsResponse.json();
        
        if (!teamStatsResponse.ok) throw new Error(teamStats.error || '获取球队统计失败');
        
        displayStatistics(matchStats, teamStats);
      } catch (err) {
        console.error('加载赛事统计失败:', err);
        document.getElementById('matchStatistics').innerHTML = '<div class="col-12 text-center text-danger">加载赛事统计失败</div>';
        document.getElementById('teamRanking').innerHTML = '<div class="col-12 text-center text-danger">加载排行榜失败</div>';
      }
    }
    
    // 显示赛事统计
    function displayStatistics(matchStats, teamStats) {
      // 显示比赛统计
      const matchStatistics = document.getElementById('matchStatistics');
      matchStatistics.innerHTML = `
        <div class="row">
          <div class="col-md-3 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">总比赛数</h5>
                <p class="card-text display-4">${matchStats.totalMatches}</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">已完成</h5>
                <p class="card-text display-4">${matchStats.completedMatches}</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">进行中</h5>
                <p class="card-text display-4">${matchStats.inProgressMatches}</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">未开始</h5>
                <p class="card-text display-4">${matchStats.upcomingMatches}</p>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // 显示球队排行榜
      const teamRanking = document.getElementById('teamRanking');
      if (teamStats.length === 0) {
        teamRanking.innerHTML = '<div class="col-12 text-center">暂无数据</div>';
        return;
      }
      
      teamRanking.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>排名</th>
              <th>球队</th>
              <th>比赛</th>
              <th>胜</th>
              <th>平</th>
              <th>负</th>
              <th>进球</th>
              <th>失球</th>
              <th>净胜球</th>
              <th>积分</th>
            </tr>
          </thead>
          <tbody>
            ${teamStats.map((team, index) => `
              <tr>
                <td>${index + 1}</td>
                <td>${team.teamName}</td>
                <td>${team.matches}</td>
                <td>${team.wins}</td>
                <td>${team.draws}</td>
                <td>${team.losses}</td>
                <td>${team.goalsFor}</td>
                <td>${team.goalsAgainst}</td>
                <td>${team.goalDifference}</td>
                <td>${team.points}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    // 加载球队列表
    async function loadTeams() {
      try {
        const response = await fetch('http://localhost:3000/api/teams');
        const teams = await response.json();
        
        if (!response.ok) throw new Error(teams.error || '获取球队数据失败');
        
        displayTeams(teams);
      } catch (err) {
        console.error('加载球队列表失败:', err);
        document.getElementById('teamsList').innerHTML = '<div class="col-12 text-center text-danger">加载球队列表失败</div>';
      }
    }
    
    // 显示球队列表
    function displayTeams(teams) {
      const teamsList = document.getElementById('teamsList');
      if (teams.length === 0) {
        teamsList.innerHTML = '<div class="col-12 text-center">暂无球队</div>';
        return;
      }
      
      teamsList.innerHTML = '';
      teams.forEach(team => {
        const teamItem = document.createElement('div');
        teamItem.className = 'mb-3 p-3 border rounded';
        teamItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5>${team.name}</h5>
              <p class="text-muted">学院: ${team.college} | 教练: ${team.coach || '未知'}</p>
              <p class="text-muted">球员数: ${team.players ? team.players.length : 0}</p>
            </div>
            <div>
              <button class="btn btn-primary me-2" onclick="viewTeamPlayers('${team.id}')">查看球员</button>
              <button class="btn btn-warning me-2" onclick="showEditTeamForm('${team.id}')">编辑</button>
              <button class="btn btn-danger" onclick="deleteTeam('${team.id}')">删除</button>
            </div>
          </div>
        `;
        teamsList.appendChild(teamItem);
      });
    }
    
    // 加载裁判列表
    async function loadReferees() {
      try {
        const response = await fetch('http://localhost:3000/api/referees');
        const referees = await response.json();
        
        if (!response.ok) throw new Error(referees.error || '获取裁判数据失败');
        
        displayReferees(referees);
      } catch (err) {
        console.error('加载裁判列表失败:', err);
        document.getElementById('refereesList').innerHTML = '<div class="col-12 text-center text-danger">加载裁判列表失败</div>';
      }
    }
    
    // 显示裁判列表
    function displayReferees(referees) {
      const refereesList = document.getElementById('refereesList');
      if (referees.length === 0) {
        refereesList.innerHTML = '<div class="col-12 text-center">暂无裁判</div>';
        return;
      }
      
      refereesList.innerHTML = '';
      referees.forEach(referee => {
        const refereeItem = document.createElement('div');
        refereeItem.className = 'mb-3 p-3 border rounded';
        refereeItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5>${referee.name}</h5>
              <p class="text-muted">级别: ${referee.level} | 经验: ${referee.experience || '未知'}</p>
              <p class="text-muted">学院: ${referee.college || '未知'} | 年级: ${referee.grade || '未知'}</p>
            </div>
            <div>
              <button class="btn btn-warning me-2" onclick="showEditRefereeForm('${referee.id}')">编辑</button>
              <button class="btn btn-danger" onclick="deleteReferee('${referee.id}')">删除</button>
            </div>
          </div>
        `;
        refereesList.appendChild(refereeItem);
      });
    }
    
    // 显示添加球队表单
    function showAddTeamForm() {
      const modal = new bootstrap.Modal(document.getElementById('addTeamModal'));
      modal.show();
    }
    
    // 显示添加裁判表单
    function showAddRefereeForm() {
      const modal = new bootstrap.Modal(document.getElementById('addRefereeModal'));
      modal.show();
    }
    
    // 添加球队
    async function addTeam() {
      const name = document.getElementById('teamName').value;
      const college = document.getElementById('teamCollege').value;
      const coach = document.getElementById('teamCoach').value;
      const logo = document.getElementById('teamLogo').value;
      
      try {
        const response = await fetch('http://localhost:3000/api/teams', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, college, coach, logo })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '添加球队失败');
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addTeamModal'));
        modal.hide();
        
        // 重新加载球队列表
        loadTeams();
        
        // 显示成功消息
        alert('球队添加成功');
      } catch (err) {
        console.error('添加球队失败:', err);
        alert('添加球队失败: ' + err.message);
      }
    }
    
    // 添加裁判
    async function addReferee() {
      const name = document.getElementById('refereeName').value;
      const college = document.getElementById('refereeCollege').value;
      const grade = document.getElementById('refereeGrade').value;
      
      try {
        const response = await fetch('http://localhost:3000/api/referees', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, college, grade })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '添加裁判失败');
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addRefereeModal'));
        modal.hide();
        
        // 重新加载裁判列表
        loadReferees();
        
        // 显示成功消息
        alert('裁判添加成功');
      } catch (err) {
        console.error('添加裁判失败:', err);
        alert('添加裁判失败: ' + err.message);
      }
    }
    
    // 查看球队球员
    async function viewTeamPlayers(teamId) {
      try {
        // 设置当前球队ID
        window.currentTeamId = teamId;
        
        // 加载球队信息
        const teamResponse = await fetch(`http://localhost:3000/api/teams/${teamId}`);
        const team = await teamResponse.json();
        
        if (!teamResponse.ok) throw new Error(team.error || '获取球队数据失败');
        
        // 设置模态框标题
        document.getElementById('playersModalTitle').textContent = `${team.name} - 球员管理`;
        
        // 加载球员列表
        await loadPlayers(teamId);
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('playersModal'));
        modal.show();
      } catch (err) {
        console.error('获取球员数据失败:', err);
        alert('获取球员数据失败');
      }
    }

    // 显示添加球员表单
    function showAddPlayerForm() {
      // 设置球队ID
      document.getElementById('addPlayerTeamId').value = window.currentTeamId;
      
      // 显示模态框
      const modal = new bootstrap.Modal(document.getElementById('addPlayerModal'));
      modal.show();
    }

    // 加载球员列表
    async function loadPlayers(teamId) {
      try {
        const response = await fetch(`http://localhost:3000/api/teams/${teamId}/players`);
        const players = await response.json();
        
        if (!response.ok) throw new Error(players.error || '获取球员数据失败');
        
        // 按号码排序
        players.sort((a, b) => parseInt(a.number) - parseInt(b.number));
        
        displayPlayers(players);
      } catch (err) {
        console.error('加载球员列表失败:', err);
        document.getElementById('playersList').innerHTML = '<div class="col-12 text-center text-danger">加载球员列表失败</div>';
      }
    }

    // 显示球员列表
    function displayPlayers(players) {
      const playersList = document.getElementById('playersList');
      if (players.length === 0) {
        playersList.innerHTML = '<div class="col-12 text-center">暂无球员</div>';
        return;
      }
      
      playersList.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>号码</th>
              <th>姓名</th>
              <th>学号</th>
            </tr>
          </thead>
          <tbody>
            ${players.map(player => `
              <tr>
                <td>${player.number}</td>
                <td>${player.name}</td>
                <td>${player.studentId || '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // 添加球员
    async function addPlayer() {
      const teamId = document.getElementById('addPlayerTeamId').value;
      const name = document.getElementById('playerName').value;
      const number = document.getElementById('playerNumber').value;
      const studentId = document.getElementById('playerStudentId').value;
      
      try {
        const response = await fetch('http://localhost:3000/api/players', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ teamId, name, number, studentId })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '添加球员失败');
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('addPlayerModal'));
        modal.hide();
        
        // 重新加载球员列表
        await loadPlayers(teamId);
        
        // 显示成功消息
        alert('球员添加成功');
      } catch (err) {
        console.error('添加球员失败:', err);
        alert('添加球员失败: ' + err.message);
      }
    }
    
    // 显示编辑球队表单
    async function showEditTeamForm(teamId) {
      try {
        const response = await fetch(`http://localhost:3000/api/teams/${teamId}`);
        const team = await response.json();
        
        if (!response.ok) throw new Error(team.error || '获取球队数据失败');
        
        // 填充表单数据
        document.getElementById('editTeamId').value = team.id;
        document.getElementById('editTeamName').value = team.name;
        document.getElementById('editTeamCollege').value = team.college;
        document.getElementById('editTeamCoach').value = team.coach || '';
        document.getElementById('editTeamLogo').value = team.logo || '';
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('editTeamModal'));
        modal.show();
      } catch (err) {
        console.error('获取球队数据失败:', err);
        alert('获取球队数据失败: ' + err.message);
      }
    }
    
    // 显示编辑裁判表单
    async function showEditRefereeForm(refereeId) {
      try {
        const response = await fetch(`http://localhost:3000/api/referees/${refereeId}`);
        const referee = await response.json();
        
        if (!response.ok) throw new Error(referee.error || '获取裁判数据失败');
        
        // 填充表单数据
        document.getElementById('editRefereeId').value = referee.id;
        document.getElementById('editRefereeName').value = referee.name;
        document.getElementById('editRefereeCollege').value = referee.college || '';
        document.getElementById('editRefereeGrade').value = referee.grade || '';
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('editRefereeModal'));
        modal.show();
      } catch (err) {
        console.error('获取裁判数据失败:', err);
        alert('获取裁判数据失败: ' + err.message);
      }
    }
    
    // 编辑球队
    async function editTeam() {
      const id = document.getElementById('editTeamId').value;
      const name = document.getElementById('editTeamName').value;
      const college = document.getElementById('editTeamCollege').value;
      const coach = document.getElementById('editTeamCoach').value;
      const logo = document.getElementById('editTeamLogo').value;
      
      try {
        const response = await fetch(`http://localhost:3000/api/teams/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, college, coach, logo })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '编辑球队失败');
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('editTeamModal'));
        modal.hide();
        
        // 重新加载球队列表
        loadTeams();
        
        // 显示成功消息
        alert('球队编辑成功');
      } catch (err) {
        console.error('编辑球队失败:', err);
        alert('编辑球队失败: ' + err.message);
      }
    }
    
    // 编辑裁判
    async function editReferee() {
      const id = document.getElementById('editRefereeId').value;
      const name = document.getElementById('editRefereeName').value;
      const college = document.getElementById('editRefereeCollege').value;
      const grade = document.getElementById('editRefereeGrade').value;
      
      try {
        const response = await fetch(`http://localhost:3000/api/referees/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, college, grade })
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '编辑裁判失败');
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('editRefereeModal'));
        modal.hide();
        
        // 重新加载裁判列表
        loadReferees();
        
        // 显示成功消息
        alert('裁判编辑成功');
      } catch (err) {
        console.error('编辑裁判失败:', err);
        alert('编辑裁判失败: ' + err.message);
      }
    }
    
    // 删除球队
    async function deleteTeam(teamId) {
      if (!confirm('确定要删除这个球队吗？')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3000/api/teams/${teamId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '删除球队失败');
        
        // 重新加载球队列表
        loadTeams();
        
        // 显示成功消息
        alert('球队删除成功');
      } catch (err) {
        console.error('删除球队失败:', err);
        alert('删除球队失败: ' + err.message);
      }
    }
    
    // 删除裁判
    async function deleteReferee(refereeId) {
      if (!confirm('确定要删除这个裁判吗？')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3000/api/referees/${refereeId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || '删除裁判失败');
        
        // 重新加载裁判列表
        loadReferees();
        
        // 显示成功消息
        alert('裁判删除成功');
      } catch (err) {
        console.error('删除裁判失败:', err);
        alert('删除裁判失败: ' + err.message);
      }
    }
    
    // 页面加载时
    window.onload = function() {
      // 设置默认日期为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('scheduleDate').value = today;
      // 加载比赛日程
      loadSchedule();
    };
  </script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>