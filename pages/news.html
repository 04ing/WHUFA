<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新闻和公告 - 武汉大学足球协会</title>
  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/pages.css" />
  <link rel="stylesheet" href="../css/responsive.css" />
</head>
<body>
  <!-- 导航栏-->
  <nav class="custom-nav">
    <div class="nav-container">
      <a href="../index.html" class="nav-brand">武汉大学足球协会</a>
      
      <!-- 移动端汉堡菜单按钮 -->
      <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span class="menu-icon"></span>
        <span class="menu-icon"></span>
        <span class="menu-icon"></span>
      </button>

      <div class="nav-links" id="navLinks">
        <a href="../index.html" class="nav-link">首页</a>
        <a href="../pages/about.html" class="nav-link">社团介绍</a>
        <a href="../pages/events.html" class="nav-link">赛事开展</a>
        <a href="../pages/departments.html" class="nav-link">部门介绍</a>
        <a href="../pages/contact.html" class="nav-link">联系我们</a>
        <div class="nav-dropdown">
          <a href="#" class="nav-link dropdown-toggle">赛事查询</a>
          <div class="dropdown-menu">
            <a href="../pages/freshmen2024search.html" class="dropdown-item">2024新生杯</a>
            <a href="../pages/Super2024.html" class="dropdown-item">2024振兴杯男子超级组</a>
            <a href="../pages/League2024.html" class="dropdown-item">2024振兴杯男子甲级组</a>
            <a href="../pages/Women2024.html" class="dropdown-item">2024振兴杯女子组</a>
            <a href="../pages/match-results.html" class="dropdown-item">赛果更新</a>
          </div>
        </div>
        <div id="userInfo" style="display: none;">
          <div class="nav-dropdown">
            <a href="#" class="nav-link dropdown-toggle" id="userNameDisplay">用户</a>
            <div class="dropdown-menu">
              <a href="../pages/profile.html" class="dropdown-item">个人中心</a>
              <a href="#" class="dropdown-item" onclick="logout()">登出</a>
            </div>
          </div>
        </div>
        <a href="../pages/register.html" class="nav-link" id="loginRegisterLink">登录/注册</a>
      </div>
    </div>
  </nav>
  
  <!-- 移动端菜单覆盖层 -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>

  <section class="p-5 pt-20">
    <div class="container">
      <h2 class="text-center mb-5">新闻和公告</h2>
      
      <!-- 搜索栏 -->
      <div class="mb-5">
        <div class="input-group">
          <input type="text" id="searchInput" class="form-control" placeholder="搜索新闻和公告...">
          <button class="btn btn-primary" onclick="searchContent()">搜索</button>
        </div>
      </div>
      
      <!-- 标签切换 -->
      <div class="mb-5">
        <ul class="nav nav-tabs">
          <li class="nav-item">
            <a class="nav-link active" href="#news" onclick="showTab('news')">新闻</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#announcements" onclick="showTab('announcements')">公告</a>
          </li>
        </ul>
      </div>
      
      <!-- 新闻列表 -->
      <div id="news" class="tab-content">
        <div class="row" id="newsList">
          <!-- 新闻项将通过JavaScript动态添加 -->
          <div class="col-12 text-center">
            <div class="spinner-border" role="status">
              <span class="sr-only">加载中...</span>
            </div>
            <p class="mt-2">加载新闻中...</p>
          </div>
        </div>
      </div>
      
      <!-- 公告列表 -->
      <div id="announcements" class="tab-content" style="display: none;">
        <div class="row" id="announcementsList">
          <!-- 公告项将通过JavaScript动态添加 -->
          <div class="col-12 text-center">
            <div class="spinner-border" role="status">
              <span class="sr-only">加载中...</span>
            </div>
            <p class="mt-2">加载公告中...</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 新闻详情模态框 -->
  <div class="modal" id="newsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalContent">
          <!-- 内容将通过JavaScript动态添加 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <footer class="p-5 bg-dark text-white text-center">
    <div class="container">
      <p class="lead">Copyright &copy; 2026 武汉大学足球协会（学生）主页</p>
    </div>
  </footer>

  <script>
    // 移动端菜单控制
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const navLinks = document.getElementById('navLinks');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    
    mobileMenuBtn.addEventListener('click', function() {
      navLinks.classList.toggle('active');
      mobileMenuOverlay.classList.toggle('active');
      document.body.classList.toggle('menu-open');
    });
    
    mobileMenuOverlay.addEventListener('click', function() {
      navLinks.classList.remove('active');
      mobileMenuOverlay.classList.remove('active');
      document.body.classList.remove('menu-open');
    });
    
    // 下拉菜单控制
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    dropdownToggles.forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        e.preventDefault();
        const dropdownMenu = this.nextElementSibling;
        dropdownMenu.classList.toggle('active');
      });
    });
    
    // 点击其他地方关闭下拉菜单
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.nav-dropdown')) {
        const dropdownMenus = document.querySelectorAll('.dropdown-menu');
        dropdownMenus.forEach(menu => {
          menu.classList.remove('active');
        });
      }
    });
    
    // 检查用户登录状态
    function checkLoginStatus() {
      const userId = localStorage.getItem('userId');
      const userName = localStorage.getItem('userName');
      
      if (userId && userName) {
        // 用户已登录，显示用户信息和登出按钮
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('userNameDisplay').textContent = userName;
        document.getElementById('loginRegisterLink').style.display = 'none';
      } else {
        // 用户未登录，显示登录/注册链接
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('loginRegisterLink').style.display = 'block';
      }
    }
    
    // 登出功能
    function logout() {
      // 清除本地存储中的用户信息
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      
      // 更新导航栏显示
      checkLoginStatus();
      
      // 跳转到首页
      window.location.href = '../index.html';
    }
    
    // 切换标签
    function showTab(tabName) {
      // 隐藏所有标签内容
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // 移除所有活动标签
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // 显示选中的标签内容
      document.getElementById(tabName).style.display = 'block';
      
      // 添加活动标签样式
      event.target.classList.add('active');
      
      // 加载对应内容
      if (tabName === 'news') {
        loadNews();
      } else if (tabName === 'announcements') {
        loadAnnouncements();
      }
    }
    
    // 加载新闻
    async function loadNews() {
      try {
        const response = await fetch('http://localhost:3000/api/news');
        const news = await response.json();
        
        if (!response.ok) throw new Error(news.error || '获取新闻失败');
        
        displayNews(news);
      } catch (err) {
        console.error('加载新闻失败:', err);
        document.getElementById('newsList').innerHTML = '<div class="col-12 text-center text-danger">加载新闻失败</div>';
      }
    }
    
    // 加载公告
    async function loadAnnouncements() {
      try {
        const response = await fetch('http://localhost:3000/api/announcements');
        const announcements = await response.json();
        
        if (!response.ok) throw new Error(announcements.error || '获取公告失败');
        
        displayAnnouncements(announcements);
      } catch (err) {
        console.error('加载公告失败:', err);
        document.getElementById('announcementsList').innerHTML = '<div class="col-12 text-center text-danger">加载公告失败</div>';
      }
    }
    
    // 显示新闻列表
    function displayNews(news) {
      const newsList = document.getElementById('newsList');
      if (news.length === 0) {
        newsList.innerHTML = '<div class="col-12 text-center">暂无新闻</div>';
        return;
      }
      
      newsList.innerHTML = '';
      news.forEach(item => {
        const newsItem = document.createElement('div');
        newsItem.className = 'col-md-6 mb-4';
        newsItem.innerHTML = `
          <div class="card">
            ${item.image ? `<img src="${item.image}" class="card-img-top" alt="${item.title}">` : ''}
            <div class="card-body">
              <h5 class="card-title">${item.title}</h5>
              <p class="card-text">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</p>
              <p class="card-text text-muted">${new Date(item.createdAt).toLocaleString()}</p>
              <button class="btn btn-primary" onclick="showNewsDetail('${item.id}')">查看详情</button>
            </div>
          </div>
        `;
        newsList.appendChild(newsItem);
      });
    }
    
    // 显示公告列表
    function displayAnnouncements(announcements) {
      const announcementsList = document.getElementById('announcementsList');
      if (announcements.length === 0) {
        announcementsList.innerHTML = '<div class="col-12 text-center">暂无公告</div>';
        return;
      }
      
      announcementsList.innerHTML = '';
      announcements.forEach(item => {
        const announcementItem = document.createElement('div');
        announcementItem.className = 'col-md-6 mb-4';
        announcementItem.innerHTML = `
          <div class="card ${item.priority === 'high' ? 'border-danger' : ''}">
            <div class="card-body">
              <h5 class="card-title">${item.title}</h5>
              <p class="card-text">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</p>
              <p class="card-text text-muted">${new Date(item.createdAt).toLocaleString()}</p>
              ${item.priority === 'high' ? '<span class="badge bg-danger">重要</span>' : ''}
              <button class="btn btn-primary mt-2" onclick="showAnnouncementDetail('${item.id}')">查看详情</button>
            </div>
          </div>
        `;
        announcementsList.appendChild(announcementItem);
      });
    }
    
    // 显示新闻详情
    async function showNewsDetail(id) {
      try {
        const response = await fetch(`http://localhost:3000/api/news/${id}`);
        const news = await response.json();
        
        if (!response.ok) throw new Error(news.error || '获取新闻详情失败');
        
        document.getElementById('modalTitle').textContent = news.title;
        document.getElementById('modalContent').innerHTML = `
          <p>${news.content}</p>
          <p class="text-muted mt-3">作者: ${news.author || '未知'} | 发布时间: ${new Date(news.createdAt).toLocaleString()}</p>
        `;
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('newsModal'));
        modal.show();
      } catch (err) {
        console.error('获取新闻详情失败:', err);
        alert('获取新闻详情失败');
      }
    }
    
    // 显示公告详情
    async function showAnnouncementDetail(id) {
      try {
        const response = await fetch(`http://localhost:3000/api/announcements/${id}`);
        const announcement = await response.json();
        
        if (!response.ok) throw new Error(announcement.error || '获取公告详情失败');
        
        document.getElementById('modalTitle').textContent = announcement.title;
        document.getElementById('modalContent').innerHTML = `
          <p>${announcement.content}</p>
          <p class="text-muted mt-3">作者: ${announcement.author || '未知'} | 发布时间: ${new Date(announcement.createdAt).toLocaleString()}</p>
        `;
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('newsModal'));
        modal.show();
      } catch (err) {
        console.error('获取公告详情失败:', err);
        alert('获取公告详情失败');
      }
    }
    
    // 搜索内容
    async function searchContent() {
      const keyword = document.getElementById('searchInput').value;
      if (!keyword) {
        alert('请输入搜索关键词');
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:3000/api/search?keyword=${encodeURIComponent(keyword)}`);
        const results = await response.json();
        
        if (!response.ok) throw new Error(results.error || '搜索失败');
        
        // 显示搜索结果
        alert(`找到 ${results.news.length} 条新闻和 ${results.announcements.length} 条公告`);
        // 这里可以实现更复杂的搜索结果展示
      } catch (err) {
        console.error('搜索失败:', err);
        alert('搜索失败');
      }
    }
    
    // 页面加载时检查登录状态并加载新闻
    window.onload = function() {
      checkLoginStatus();
      loadNews();
    };
  </script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>